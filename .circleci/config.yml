version: 2
jobs:
  test-job:
    working_directory: ~/bp-cron
    docker:
    - image: nikolaik/python-nodejs:latest
    steps:
    - checkout
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "requirements.txt" }}
        - v1-dependencies-
    - run:
        name: Install dependencies
        command: |
          python3 -m venv venv
          source ./venv/bin/activate
          pip install -U pip setuptools tox
    - run:
        name: Run test
        command: |
          source ./venv/bin/activate
          tox -epy37,flake8
    - save_cache:
        paths:
        - ./venv
        key: v1-dependencies-{{ checksum "requirements.txt" }}
    - store_test_results:
        path: test-results
  deploy-job:
    working_directory: ~/bp-cron
    docker:
    - image: nikolaik/python-nodejs:latest
    steps:
    - checkout
    - run:
        command: echo ${ENV} > ~/.env
    - run:
        command: npm install
    - run:
        name: install-serverless
        command: npm install -g serverless@1.41.0
    - run:
        name: serverless-python-requirements install
        command: sls plugin install -n serverless-python-requirements@4.3.0
    - run:
        name: serverless-prune-plugin install
        command: sls plugin install -n serverless-prune-plugin@1.3.2
    - deploy:
        name: Deploy by Serverless Framework
        command: |
          sls config credentials -k ${AWS_ACCESS_KEY_ID} -s ${AWS_SECRET_ACCESS_KEY} -p aws
          sls deploy
workflows:
  test-and-deploy:
    jobs:
    - test-job
    - deploy-job:
        filters:
          branches:
            only:
            - master
        requires:
        - test-job
  version: 2
